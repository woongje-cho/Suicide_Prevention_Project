# ============================================================
# Bridge Guardian — 자살 예방 순찰 로봇 설정 파일
# ============================================================

camera:
  source: "realsense"          # "realsense" 또는 비디오 파일 경로 (예: "test_video.mp4")
  width: 640
  height: 480
  fps: 30
  depth_width: 640
  depth_height: 480

detection:
  model_path: "yolov8n-pose.pt"   # .pt (개발) 또는 .engine (Jetson TensorRT)
  confidence: 0.5
  iou_threshold: 0.45
  device: 0                       # GPU 인덱스 또는 "cpu"
  input_size: 640
  tracker_config: "bytetrack.yaml"

tracking:
  max_age_seconds: 3.0            # 감지 안되면 트랙 삭제까지의 시간
  position_history_size: 150      # ~5초 (30fps 기준)
  keypoint_history_size: 30       # ~1초

risk_assessment:
  # ROI 영역: 정규화 좌표 [0-1]로 정의된 난간/가장자리 다각형
  railing_roi_zones:
    - name: "left_railing"
      polygon: [[0.0, 0.3], [0.15, 0.3], [0.15, 0.9], [0.0, 0.9]]
    - name: "right_railing"
      polygon: [[0.85, 0.3], [1.0, 0.3], [1.0, 0.9], [0.85, 0.9]]
  railing_depth_min_m: 0.5
  railing_depth_max_m: 3.0

  stationary_time_threshold_s: 30
  stationary_movement_threshold_px: 25

  climbing_knee_hip_ratio: 0.15
  climbing_leg_angle_threshold: 160
  climbing_temporal_window: 15
  torso_lean_threshold_deg: 25
  shoulder_width_ratio_side: 0.08
  keypoint_confidence_min: 0.3

  weights:
    stationary_time: 0.30
    railing_proximity: 0.35
    dangerous_pose: 0.35

  time_multipliers:
    dawn:    { start: 4,  end: 6,  multiplier: 1.5 }
    night:   { start: 22, end: 4,  multiplier: 1.3 }
    default: 1.0

  risk_levels:
    observe: 0.3
    warning: 0.5
    danger: 0.7
    critical: 0.85

alerts:
  enabled: true
  console: true
  log_file: "alerts.log"
  min_alert_level: "WARNING"
  cooldown_seconds: 60
  twilio:
    enabled: false
    account_sid: ""                # 환경변수 TWILIO_ACCOUNT_SID 사용 권장
    auth_token: ""                 # 환경변수 TWILIO_AUTH_TOKEN 사용 권장
    from_number: ""
    to_numbers: []
    call_on_critical: true
    sms_on_warning: true

visualization:
  enabled: true
  show_skeleton: true
  show_roi_zones: true
  show_risk_labels: true
  show_fps: true
  save_alert_frames: true
  save_dir: "alert_captures"

# ============================================================
# LiDAR (RPLidar A1/A2)
# ============================================================
lidar:
  enabled: true
  # port: "/dev/ttyUSB0"         # Linux/Jetson
  port: "COM3"                   # Windows (장치관리자에서 확인)
  baudrate: 115200
  scan_mode: 0                   # 0=Standard, 1=Express, 2=Boost
  max_range_m: 12.0
  min_range_m: 0.15
  scan_frequency_hz: 10
  obstacle_threshold_m: 0.5     # 장애물 감지 거리 임계값
  safety_zone_m: 0.3            # 긴급 정지 거리

# ============================================================
# 센서 퓨전 (카메라 + LiDAR + 깊이)
# ============================================================
sensor_fusion:
  enabled: true
  camera_lidar_offset:           # 카메라↔LiDAR 상대 위치 (m)
    x: 0.0
    y: 0.0
    z: 0.15
  fusion_method: "weighted"      # "weighted" | "kalman"
  depth_weight: 0.4
  lidar_weight: 0.6
  max_association_distance_m: 1.0

# ============================================================
# GPS (NMEA over Serial)
# ============================================================
gps:
  enabled: true
  # port: "/dev/ttyACM0"         # Linux/Jetson
  port: "COM4"                   # Windows (장치관리자에서 확인)
  baudrate: 9600
  update_rate_hz: 1
  min_satellites: 4
  default_latitude: 37.5135     # 마포대교 기본 좌표 (GPS 미수신 시)
  default_longitude: 126.9440

# ============================================================
# 모터 제어 (DC 모터 / PWM)
# ============================================================
motor:
  enabled: true
  # port: "/dev/ttyACM0"         # Linux/Jetson
  port: "COM5"                   # Windows (장치관리자에서 확인)
  baudrate: 9600
  left_pin_forward: 17
  left_pin_backward: 27
  right_pin_forward: 22
  right_pin_backward: 23
  left_pwm_pin: 12
  right_pwm_pin: 13
  pwm_frequency: 1000
  max_speed: 100                 # PWM 듀티비 (%)
  patrol_speed: 60
  approach_speed: 30
  turn_speed: 45

# ============================================================
# 내비게이션 / 순찰
# ============================================================
navigation:
  enabled: true
  mode: "patrol"                 # "patrol" | "manual" | "standby"
  patrol_waypoints:              # GPS 좌표 기반 순찰 경유지
    - name: "start"
      latitude: 37.5135
      longitude: 126.9440
    - name: "mid_east"
      latitude: 37.5136
      longitude: 126.9455
    - name: "end_east"
      latitude: 37.5137
      longitude: 126.9470
    - name: "mid_west"
      latitude: 37.5134
      longitude: 126.9425
  waypoint_reach_radius_m: 2.0
  patrol_loop: true
  pause_on_detection: true       # 사람 감지 시 순찰 일시정지
  pause_duration_s: 120          # 감지 후 정지 유지 시간

# ============================================================
# 행동 임계값 (로봇 반응 결정)
# ============================================================
behavior:
  approach_risk_level: "WARNING"     # 이 수준 이상이면 접근
  approach_distance_m: 3.0           # 대상까지 접근 거리
  speak_risk_level: "WARNING"        # 이 수준 이상이면 TTS 재생
  emergency_call_level: "CRITICAL"   # 이 수준 이상이면 긴급 전화
  retreat_after_safe_s: 30           # SAFE 전환 후 후퇴까지 대기 시간
  max_approach_attempts: 3

# ============================================================
# TTS (Text-to-Speech) 설정
# ============================================================
tts:
  enabled: true
  engine: "pyttsx3"              # "pyttsx3" | "gtts" | "auto"
  language: "ko"
  rate: 150                      # pyttsx3 말하기 속도
  volume: 0.9                    # 0.0 ~ 1.0
